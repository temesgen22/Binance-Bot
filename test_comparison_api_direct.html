<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Strategy Comparison API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        #results {
            margin-top: 20px;
        }
    </style>
    <script src="/static/auth.js"></script>
</head>
<body>
    <h1>Strategy Comparison API Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Check Authentication</h2>
        <button onclick="testAuth()">Test Auth Token</button>
        <div id="auth-result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Call Strategies Performance API</h2>
        <button onclick="testStrategiesAPI()">Test /api/strategies/performance</button>
        <div id="api-result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Simulate Frontend Logic</h2>
        <button onclick="testFrontendLogic()">Test Frontend Parsing</button>
        <div id="frontend-result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 4: Check Browser Console</h2>
        <p>Open browser console (F12) to see detailed logs</p>
    </div>
    
    <div id="results"></div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>[${type.toUpperCase()}]</strong> ${message}`;
            results.appendChild(div);
            console.log(`[${type.toUpperCase()}]`, message);
        }

        async function testAuth() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.innerHTML = 'Testing...';
            
            try {
                const token = localStorage.getItem('binance_bot_token');
                if (!token) {
                    resultDiv.innerHTML = '<span class="error">❌ No auth token found. Please login first.</span>';
                    log('No auth token found', 'error');
                    return;
                }
                
                resultDiv.innerHTML = '<span class="success">✅ Auth token found</span>';
                log(`Auth token found: ${token.substring(0, 20)}...`, 'success');
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
                log(`Auth test error: ${error.message}`, 'error');
            }
        }

        async function testStrategiesAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = 'Testing...';
            
            try {
                log('Fetching from /api/strategies/performance', 'info');
                
                const response = await authFetch('/api/strategies/performance');
                log(`Response status: ${response.status} ${response.statusText}`, 'info');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `<span class="error">❌ Error ${response.status}: ${errorText}</span>`;
                    log(`API error: ${response.status} - ${errorText}`, 'error');
                    return;
                }
                
                const contentType = response.headers.get('content-type') || '';
                log(`Content-Type: ${contentType}`, 'info');
                
                if (!contentType.includes('application/json')) {
                    const text = await response.text();
                    resultDiv.innerHTML = `<span class="error">❌ Expected JSON but got ${contentType}</span>`;
                    log(`Wrong content type: ${contentType}`, 'error');
                    return;
                }
                
                const data = await response.json();
                log('API Response received:', 'success');
                log(`Response keys: ${Object.keys(data).join(', ')}`, 'info');
                log(`Has 'strategies' key: ${'strategies' in data}`, 'info');
                
                const strategies = data.strategies || data || [];
                log(`Strategies count: ${strategies.length}`, 'info');
                log(`Strategies is array: ${Array.isArray(strategies)}`, 'info');
                
                if (strategies.length === 0) {
                    resultDiv.innerHTML = '<span class="error">⚠️ API returned empty strategies array</span>';
                    log('No strategies found in response', 'error');
                } else {
                    resultDiv.innerHTML = `<span class="success">✅ Found ${strategies.length} strategies</span>`;
                    log(`Found ${strategies.length} strategies`, 'success');
                    
                    strategies.forEach((strategy, index) => {
                        log(`Strategy ${index}: ${strategy.strategy_name || strategy.name || 'Unknown'} (${strategy.strategy_id || strategy.id})`, 'info');
                    });
                }
                
                // Show full response
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(data, null, 2);
                resultDiv.appendChild(pre);
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
                log(`API test error: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        async function testFrontendLogic() {
            const resultDiv = document.getElementById('frontend-result');
            resultDiv.innerHTML = 'Testing...';
            
            try {
                // Simulate the exact frontend logic
                log('Simulating frontend logic...', 'info');
                
                const response = await authFetch('/api/strategies/performance');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                log('Data received', 'success');
                
                // This is the exact logic from dashboard.js
                const strategies = data.strategies || data || [];
                log(`Parsed strategies: ${strategies.length}`, 'info');
                
                if (!Array.isArray(strategies)) {
                    throw new Error('strategies is not an array');
                }
                
                // Simulate populateStrategySelector
                const select = document.createElement('select');
                select.id = 'test-select';
                select.multiple = true;
                select.size = 5;
                
                if (strategies.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No strategies available';
                    option.disabled = true;
                    select.appendChild(option);
                    resultDiv.innerHTML = '<span class="error">⚠️ No strategies to populate</span>';
                } else {
                    strategies.forEach(strategy => {
                        const option = document.createElement('option');
                        option.value = strategy.strategy_id || strategy.id || '';
                        const name = strategy.strategy_name || strategy.name || 'Unknown';
                        const symbol = strategy.symbol || '';
                        const type = strategy.strategy_type || strategy.type || '';
                        option.textContent = `${name} (${symbol}) - ${type}`;
                        select.appendChild(option);
                    });
                    
                    resultDiv.innerHTML = `<span class="success">✅ Successfully populated ${strategies.length} strategies</span>`;
                    resultDiv.appendChild(select);
                    log(`Populated ${strategies.length} options`, 'success');
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
                log(`Frontend logic test error: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        // Auto-run auth test on load
        window.addEventListener('load', () => {
            log('Page loaded. Run tests manually or check console.', 'info');
        });
    </script>
</body>
</html>

